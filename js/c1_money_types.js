// =================================================================
// FILE: js/unit1.js (Ê∑±Ëâ≤‰∏ªÈ°å‰øÆÊ≠£Áâà)
// =================================================================

// Â∞áGameÂÆöÁæ©ÁÇ∫ÂÖ®Â±ÄËÆäÈáè‰ª•ÊîØÊåÅonclick‰∫ã‰ª∂
let Game;

document.addEventListener('DOMContentLoaded', () => {
    Game = {
        // =====================================================
        // Ë≥áÊñô
        // =====================================================
        gameData: {
            title: "ÂñÆÂÖÉ‰∏ÄÔºöË™çË≠òÈå¢Âπ£ÂíåÁ¥ôÈàî",
            items: {
                coins: [
                    { 
                        value: 1, 
                        name: '1ÂÖÉ', 
                        images: { 
                            front: 'images/1_yuan_front.png', 
                            back: 'images/1_yuan_back.png' 
                        } 
                    },
                    { 
                        value: 5, 
                        name: '5ÂÖÉ', 
                        images: { 
                            front: 'images/5_yuan_front.png', 
                            back: 'images/5_yuan_back.png' 
                        } 
                    },
                    { 
                        value: 10, 
                        name: '10ÂÖÉ', 
                        images: { 
                            front: 'images/10_yuan_front.png', 
                            back: 'images/10_yuan_back.png' 
                        } 
                    },
                    { 
                        value: 50, 
                        name: '50ÂÖÉ', 
                        images: { 
                            front: 'images/50_yuan_front.png', 
                            back: 'images/50_yuan_back.png' 
                        } 
                    }
                ],
                notes: [
                    { 
                        value: 100, 
                        name: '100ÂÖÉ', 
                        images: { 
                            front: 'images/100_yuan_front.png', 
                            back: 'images/100_yuan_back.png' 
                        } 
                    },
                    { 
                        value: 500, 
                        name: '500ÂÖÉ', 
                        images: { 
                            front: 'images/500_yuan_front.png', 
                            back: 'images/500_yuan_back.png' 
                        } 
                    },
                    { 
                        value: 1000, 
                        name: '1000ÂÖÉ', 
                        images: { 
                            front: 'images/1000_yuan_front.png', 
                            back: 'images/1000_yuan_back.png' 
                        } 
                    }
                ]
            }
        },

        // =====================================================
        // ÁãÄÊÖã
        // =====================================================
        state: {
            score: 0,
            totalQuestions: 10,
            currentQuestionIndex: 0,
            quizQuestions: [],
            isAnswering: false,
            settings: { 
                category: null, 
                difficulty: null, 
                mode: null,
                questionCount: 10
            }
        },

        // =====================================================
        // DOM ÂÖÉÁ¥†
        // =====================================================
        elements: {},

        // =====================================================
        // Ë™ûÈü≥
        // =====================================================
        speech: {
            synth: window.speechSynthesis,
            voice: null,
            isReady: false,

            init() {
                const setVoice = () => {
                    const voices = this.synth.getVoices();
                    if (voices.length === 0) return;
                    
                    const preferredVoices = [
                        'Microsoft HsiaoChen Online', 
                        'Google ÂúãË™û (Ëá∫ÁÅ£)'
                    ];
                    
                    this.voice = voices.find(v => preferredVoices.includes(v.name));
                    
                    if (!this.voice) {
                        const otherTWVoices = voices.filter(v => 
                            v.lang === 'zh-TW' && !v.name.includes('Hanhan')
                        );
                        if (otherTWVoices.length > 0) { 
                            this.voice = otherTWVoices[0]; 
                        }
                    }
                    
                    if (!this.voice) { 
                        this.voice = voices.find(v => v.lang === 'zh-TW'); 
                    }
                    
                    if (this.voice) {
                        this.isReady = true;
                        console.log(`Ë™ûÈü≥Â∑≤Â∞±Á∑í: ${this.voice.name}`);
                        this.synth.onvoiceschanged = null;
                    }
                };
                
                this.synth.onvoiceschanged = setVoice;
                setVoice();
            }
        },

        // =====================================================
        // ÂàùÂßãÂåñ
        // =====================================================
        init() {
            this.speech.init();
            this.initAudio();
            this.showSettings();
        },

        // =====================================================
        // Ë®≠ÂÆöÁï´Èù¢ (Êé°Áî®unit6Ê®£ÂºèÁµêÊßã)
        // =====================================================
        showSettings() {
            const app = document.getElementById('app');
            const settings = this.state.settings;
            
            app.innerHTML = `
                <div class="unit-welcome">
                    <div class="welcome-content">
                        <h1>${this.gameData.title}</h1>
                        
                        <div class="game-settings">
                            <div class="setting-group">
                                <label>üéØ Èõ£Â∫¶ÈÅ∏ÊìáÔºö</label>
                                <div class="button-group">
                                    <button class="selection-btn ${settings.difficulty === 'easy' ? 'active' : ''}" 
                                            data-type="difficulty" data-value="easy">
                                        Á∞°ÂñÆ (ÁúãÂúñÈÅ∏Âúñ)
                                    </button>
                                    <button class="selection-btn ${settings.difficulty === 'normal' ? 'active' : ''}" 
                                            data-type="difficulty" data-value="normal">
                                        ÊôÆÈÄö (ÁúãÂ≠óÈÅ∏Âúñ)
                                    </button>
                                    <button class="selection-btn ${settings.difficulty === 'hard' ? 'active' : ''}" 
                                            data-type="difficulty" data-value="hard">
                                        Âõ∞Èõ£ (ËÅΩÈü≥ÈÅ∏Âúñ)
                                    </button>
                                </div>
                            </div>
                            
                            <div class="setting-group">
                                <label>üí∞ Âπ£ÂÄºÈÅ∏ÊìáÔºö</label>
                                <div class="button-group">
                                    <button class="selection-btn ${settings.category === 'coins' ? 'active' : ''}" 
                                            data-type="category" data-value="coins">
                                        Á°¨Âπ£
                                    </button>
                                    <button class="selection-btn ${settings.category === 'notes' ? 'active' : ''}" 
                                            data-type="category" data-value="notes">
                                        Á¥ôÈàî
                                    </button>
                                    <button class="selection-btn ${settings.category === 'mixed' ? 'active' : ''}" 
                                            data-type="category" data-value="mixed">
                                        Ê∑∑Âêà
                                    </button>
                                </div>
                            </div>
                            
                            <div class="setting-group">
                                <label>üé≤ È°åÁõÆË®≠ÂÆöÔºö</label>
                                <div class="button-group">
                                    <button class="selection-btn ${settings.questionCount === 5 ? 'active' : ''}" 
                                            data-type="questions" data-value="5">
                                        5È°å
                                    </button>
                                    <button class="selection-btn ${settings.questionCount === 10 ? 'active' : ''}" 
                                            data-type="questions" data-value="10">
                                        10È°å
                                    </button>
                                    <button class="selection-btn ${settings.questionCount === 15 ? 'active' : ''}" 
                                            data-type="questions" data-value="15">
                                        15È°å
                                    </button>
                                    <button class="selection-btn ${settings.questionCount === 20 ? 'active' : ''}" 
                                            data-type="questions" data-value="20">
                                        20È°å
                                    </button>
                                    <button class="selection-btn ${settings.questionCount === 'custom' ? 'active' : ''}" 
                                            data-type="questions" data-value="custom">
                                        Ëá™Ë®Ç
                                    </button>
                                </div>
                            </div>
                            
                            <div class="setting-group">
                                <label>üìã Ê∏¨È©óÊ®°ÂºèÔºö</label>
                                <div class="button-group">
                                    <button class="selection-btn ${settings.mode === 'retry' ? 'active' : ''}" 
                                            data-type="mode" data-value="retry">
                                        ÂèçË§á‰ΩúÁ≠î
                                    </button>
                                    <button class="selection-btn ${settings.mode === 'proceed' ? 'active' : ''}" 
                                            data-type="mode" data-value="proceed">
                                        ÂñÆÊ¨°‰ΩúÁ≠î
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="game-buttons">
                            <button class="back-btn" onclick="window.location.href='index.html'">
                                ËøîÂõû‰∏ªÈÅ∏ÂñÆ
                            </button>
                            <button id="start-quiz-btn" class="start-btn" disabled>
                                Ë´ãÂÆåÊàêÊâÄÊúâÈÅ∏Êìá
                            </button>
                        </div>
                    </div>
                </div>
            `;

            // ‰ΩøÁî®‰∫ã‰ª∂ÂßîÊ¥æÊñπÂºèËôïÁêÜÊâÄÊúâË®≠ÂÆöÊåâÈàï
            const gameSettings = app.querySelector('.game-settings');
            gameSettings.addEventListener('click', this.handleSelection.bind(this));
            
            const startBtn = app.querySelector('#start-quiz-btn');
            startBtn.addEventListener('click', this.start.bind(this));
        },

        handleSelection(event) {
            const btn = event.target.closest('.selection-btn');
            if (!btn) return;

            const { type, value } = btn.dataset;
            
            // Êí≠ÊîæÈÅ∏ÂñÆÈÅ∏ÊìáÈü≥Êïà
            this.playMenuSelectSound();
            
            // ËôïÁêÜÈ°åÁõÆË®≠ÂÆöÈÅ∏È†Ö
            if (type === 'questions') {
                if (value === 'custom') {
                    this.showCustomQuestionInput();
                    return;
                } else {
                    this.state.settings.questionCount = parseInt(value);
                    this.state.totalQuestions = parseInt(value);
                    this.hideCustomQuestionInput();
                }
            } else {
                this.state.settings[type] = value;
            }

            // Êõ¥Êñ∞ÂêåÁµÑÊåâÈàïÁöÑactiveÁãÄÊÖã
            const buttonGroup = btn.closest('.button-group');
            buttonGroup.querySelectorAll('.selection-btn')
                .forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            // Ê™¢Êü•ÊòØÂê¶ÊâÄÊúâÂøÖË¶ÅË®≠ÂÆöÈÉΩÂ∑≤ÂÆåÊàê
            this.updateStartButton();
        },

        // ÂàùÂßãÂåñÈü≥Êïà
        initAudio() {
            try {
                this.menuSelectAudio = new Audio('audio/menu-select.mp3');
                this.menuSelectAudio.volume = 0.5;
                this.menuSelectAudio.preload = 'auto';
            } catch (error) {
                console.log('ÁÑ°Ê≥ïËºâÂÖ•ÈÅ∏ÂñÆÈü≥Êïà:', error);
            }
        },

        // Êí≠ÊîæÈÅ∏ÂñÆÈÅ∏ÊìáÈü≥Êïà
        playMenuSelectSound() {
            try {
                if (this.menuSelectAudio) {
                    this.menuSelectAudio.currentTime = 0;
                    this.menuSelectAudio.play().catch(e => {
                        console.log('Èü≥ÊïàÊí≠ÊîæÂ§±Êïó:', e);
                    });
                }
            } catch (error) {
                console.log('ÁÑ°Ê≥ïÊí≠ÊîæÈÅ∏ÂñÆÈü≥Êïà:', error);
            }
        },

        // È°ØÁ§∫Ëá™Ë®ÇÈ°åÁõÆÊï∏ÈáèËº∏ÂÖ•Ê°Ü
        showCustomQuestionInput() {
            this.showNumberInput('Ë´ãËº∏ÂÖ•È°åÁõÆÊï∏Èáè', (value) => {
                const questionCount = parseInt(value);
                if (isNaN(questionCount) || questionCount < 1 || questionCount > 100) {
                    alert('Ë´ãËº∏ÂÖ• 1-100 ‰πãÈñìÁöÑÊúâÊïàÊï∏Â≠ó');
                    return false;
                }
                
                this.state.settings.questionCount = questionCount;
                this.state.totalQuestions = questionCount;
                
                // Êõ¥Êñ∞activeÁãÄÊÖã
                const customBtn = document.querySelector('[data-value="custom"]');
                if (customBtn) {
                    const buttonGroup = customBtn.closest('.button-group');
                    buttonGroup.querySelectorAll('.selection-btn')
                        .forEach(b => b.classList.remove('active'));
                    customBtn.classList.add('active');
                }
                
                // Ê™¢Êü•ÊòØÂê¶ÂèØ‰ª•ÈñãÂßãÈÅäÊà≤
                this.updateStartButton();
                
                alert(`Â∑≤Ë®≠ÂÆöÊ∏¨È©óÈ°åÊï∏ÁÇ∫ ${questionCount} È°å`);
                return true;
            });
        },

        // Èö±ËóèËá™Ë®ÇÈ°åÁõÆÊï∏ÈáèËº∏ÂÖ•Ê°Ü
        hideCustomQuestionInput() {
            // ‰∏çÂÜçÈúÄË¶ÅÈö±ËóèÔºåÂõ†ÁÇ∫‰ΩøÁî®ÂΩàÂá∫ÂºèÊï∏Â≠óÈÅ∏ÊìáÂô®
        },

        // Êõ¥Êñ∞ÈñãÂßãÊåâÈàïÁãÄÊÖã
        updateStartButton() {
            const { category, difficulty, mode, questionCount } = this.state.settings;
            const startBtn = document.getElementById('start-quiz-btn');
            
            if (category && difficulty && mode && questionCount) {
                startBtn.disabled = false;
                startBtn.textContent = 'ÈñãÂßãÊ∏¨È©óÔºÅ';
                startBtn.classList.remove('disabled');
            } else {
                startBtn.disabled = true;
                startBtn.textContent = 'Ë´ãÂÆåÊàêÊâÄÊúâÈÅ∏Êìá';
                startBtn.classList.add('disabled');
            }
        },

        // =====================================================
        // ÈÅäÊà≤ÊµÅÁ®ã
        // =====================================================
        start() {
            this.state.score = 0;
            this.state.currentQuestionIndex = 0;
            this.generateQuestions();
            this.setupQuizUI();
            this.loadNextQuestion();
        },

        setupQuizUI() {
            const gameContainer = document.getElementById('app');
            gameContainer.innerHTML = `
                <div class="store-layout">
                    <div class="title-bar">
                        <div class="title-bar-left">
                            <div class="progress-info">Á¨¨ 1 / ${this.state.totalQuestions} È°å</div>
                        </div>
                        <div class="title-bar-center">
                            <div class="target-amount">Ë™çË≠òÈå¢Âπ£ÂíåÁ¥ôÈàî</div>
                        </div>
                        <div class="title-bar-right">
                            <div class="score-info">ÂàÜÊï∏: 0 ÂàÜ</div>
                            <button id="back-to-menu-btn" class="back-to-menu-btn">ËøîÂõû‰∏ªÈÅ∏ÂñÆ</button>
                        </div>
                    </div>
                    
                    <div class="unified-task-frame">
                        <div id="question-area" class="task-description"></div>
                        <div id="feedback-area" class="answer-feedback-area" style="display: none; text-align: center; padding: 20px;"></div>
                        <h3 id="options-title" class="section-title" style="display: none;">Ë´ãÈÅ∏ÊìáÊ≠£Á¢∫Á≠îÊ°à</h3>
                        <div id="options-area" class="product-selection-area"></div>
                    </div>
                </div>
            `;
            
            this.elements.questionArea = document.getElementById('question-area');
            this.elements.optionsArea = document.getElementById('options-area');
            this.elements.feedbackArea = document.getElementById('feedback-area');
            
            // Á∂ÅÂÆöËøîÂõû‰∏ªÈÅ∏ÂñÆÊåâÈàï‰∫ã‰ª∂
            const backBtn = document.querySelector('#back-to-menu-btn');
            if (backBtn) {
                backBtn.addEventListener('click', () => {
                    window.location.href = 'index.html';
                });
            }
        },

        loadNextQuestion() {
            this.state.isAnswering = false;
            
            if (this.state.currentQuestionIndex >= this.state.totalQuestions) {
                this.endGame();
                return;
            }

            const question = this.state.quizQuestions[this.state.currentQuestionIndex];
            this.state.currentQuestionIndex++;
            
            this.updateProgress();
            this.elements.optionsArea.innerHTML = '';
            this.elements.feedbackArea.innerHTML = '';
            this.elements.feedbackArea.style.display = 'none';
            
            // Èö±ËóèÈÅ∏È†ÖÊ®ôÈ°å
            const optionsTitle = document.getElementById('options-title');
            if (optionsTitle) {
                optionsTitle.style.display = 'none';
            }
            
            // Á¢∫‰øùÊ∏ÖÈô§‰πãÂâçÁöÑ‰∏≠Â§ÆÂõûÈ•ã
            this.hideCenterFeedback();

            const { difficulty } = this.state.settings;
            const questionText = `Ë´ãÊâæÂá∫ ${question.answer.name}`;
            const questionImage = this.getRandomImage(question.answer);

            switch (difficulty) {
                case 'easy':
                    this.elements.questionArea.innerHTML = `
                        <h2 class="section-title">Ë´ãÊâæÂá∫Áõ∏ÂêåÁöÑÈå¢Âπ£/Á¥ôÈàî</h2>
                        <div class="target-item-display">
                            <img src="${questionImage}" alt="È°åÁõÆ" class="target-money-img">
                        </div>
                    `;
                    break;
                case 'normal':
                    this.elements.questionArea.innerHTML = `
                        <h2 class="section-title">Ë´ãÊâæÂá∫‰ª•‰∏ãÈå¢Âπ£/Á¥ôÈàî</h2>
                        <div class="target-item-display">
                            <div class="item-details">
                                <div class="item-name">${question.answer.name}</div>
                            </div>
                        </div>
                    `;
                    break;
                case 'hard':
                    this.elements.questionArea.innerHTML = `
                        <h2 class="section-title">Ë´ãËÅΩÈü≥ÊâæÂá∫Èå¢Âπ£/Á¥ôÈàî</h2>
                        <div class="target-item-display">
                            <svg id="replay-audio-btn" class="replay-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"></path>
                            </svg>
                            <p class="target-hint">ÈªûÊìäÊí≠ÊîæÊåâÈàïËÅΩÈ°åÁõÆ</p>
                        </div>
                    `;
                    document.getElementById('replay-audio-btn').addEventListener('click', () => {
                        this.speak(questionText);
                    });
                    break;
            }
            
            this.speak(questionText, () => {
                this.renderOptions(question.options, questionImage, question.answer);
            });
        },

        generateQuestions() {
            const { category } = this.state.settings;
            let sourceData;
            
            if (category === 'mixed') {
                sourceData = [...this.gameData.items.coins, ...this.gameData.items.notes];
            } else {
                sourceData = this.gameData.items[category];
            }
            
            this.state.quizQuestions = [];
            
            for (let i = 0; i < this.state.totalQuestions; i++) {
                const allItems = [...sourceData];
                const correctItem = allItems.splice(
                    Math.floor(Math.random() * allItems.length), 1
                )[0];
                
                let options = [correctItem];
                
                while (options.length < 3 && allItems.length > 0) {
                    const wrongOption = allItems.splice(
                        Math.floor(Math.random() * allItems.length), 1
                    )[0];
                    
                    if (!options.some(opt => opt.value === wrongOption.value)) {
                        options.push(wrongOption);
                    }
                }
                
                this.state.quizQuestions.push({
                    answer: correctItem,
                    options: this.shuffleArray(options)
                });
            }
        },

        renderOptions(options, questionImage, correctAnswer) {
            // È°ØÁ§∫ÈÅ∏È†ÖÊ®ôÈ°å
            const optionsTitle = document.getElementById('options-title');
            if (optionsTitle) {
                optionsTitle.style.display = 'block';
            }
            
            this.elements.optionsArea.innerHTML = `
                <div class="products-grid horizontal-layout"></div>
            `;
            const productsGrid = this.elements.optionsArea.querySelector('.products-grid');
            
            options.forEach(option => {
                const button = document.createElement('div');
                button.className = 'product-item';
                button.dataset.value = option.value;
                button.setAttribute('tabindex', '0');
                button.setAttribute('role', 'button');
                
                let optionImageSrc;
                if (this.state.settings.difficulty === 'easy' && 
                    option.value === correctAnswer.value) {
                    optionImageSrc = questionImage;
                } else {
                    optionImageSrc = this.getRandomImage(option);
                }
                
                button.innerHTML = `
                    <img src="${optionImageSrc}" alt="${option.name}">
                    <div class="product-info">
                        <div class="product-name">${option.name}</div>
                    </div>
                `;
                
                button.addEventListener('click', (e) => this.checkAnswer(e, correctAnswer));
                button.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        this.checkAnswer(e, correctAnswer);
                    }
                });

                const speakOptionName = () => {
                    if (this.state.isAnswering) return;
                    this.speak(option.name);
                };

                button.addEventListener('mouseenter', speakOptionName);
                button.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    speakOptionName();
                }, { passive: false });

                productsGrid.appendChild(button);
            });
        },

        checkAnswer(event, correctAnswer) {
            this.state.isAnswering = true;
            const selectedBtn = event.currentTarget;
            const selectedValue = parseInt(selectedBtn.dataset.value, 10);
            const isCorrect = selectedValue === correctAnswer.value;
            const { mode } = this.state.settings;

            this.elements.optionsArea.querySelectorAll('.product-item')
                .forEach(btn => btn.style.pointerEvents = 'none');

            if (isCorrect) {
                this.state.score++;
                selectedBtn.classList.add('selected');
                
                // È°ØÁ§∫Á≠îÂ∞çÂúñÁ§∫ÔºàÊ≠£ÊñπÂΩ¢ÔºåË¶ñÁ™óÊ≠£‰∏≠Â§ÆÔºâ
                this.showCenterFeedback('üéâ', '#4CAF50', 'Á≠îÂ∞ç‰∫ÜÔºÅ');
                document.getElementById('correct-sound')?.play();
                
                this.speak('Á≠îÂ∞ç‰∫Ü', () => 
                    setTimeout(() => {
                        this.hideCenterFeedback();
                        this.loadNextQuestion();
                    }, 1200)
                );
            } else {
                selectedBtn.classList.add('incorrect-selection');
                document.getElementById('error-sound')?.play();
                
                setTimeout(() => {
                    if (mode === 'retry') {
                        this.showCenterFeedback('‚ùå', '#f44336', 'Á≠îÈåØ‰∫ÜÔºåÂÜçË©¶‰∏ÄÊ¨°ÔºÅ');
                        
                        this.speak('Á≠îÈåØ‰∫ÜÔºåÂÜçË©¶‰∏ÄÊ¨°', () => {
                            setTimeout(() => {
                                selectedBtn.classList.remove('incorrect-selection');
                                this.hideCenterFeedback();
                                this.elements.optionsArea.querySelectorAll('.product-item')
                                    .forEach(btn => btn.style.pointerEvents = 'auto');
                                this.state.isAnswering = false;
                            }, 1500);
                        });
                    } else {
                        const correctBtn = this.elements.optionsArea
                            .querySelector(`[data-value="${correctAnswer.value}"]`);
                        
                        if (correctBtn) correctBtn.classList.add('selected');
                        
                        const feedbackText = `Á≠îÈåØ‰∫ÜÔºåÊ≠£Á¢∫Á≠îÊ°àÊòØ ${correctAnswer.name}`;
                        this.showCenterFeedback('‚ùå', '#f44336', feedbackText);
                        
                        this.speak(feedbackText, () => 
                            setTimeout(() => {
                                this.hideCenterFeedback();
                                this.loadNextQuestion();
                            }, 2000)
                        );
                    }
                }, 200);
            }
        },

        // È°ØÁ§∫Ë¶ñÁ™óÊ≠£‰∏≠Â§ÆÁöÑÂõûÈ•ãÂúñÁ§∫ÔºàÊ≠£ÊñπÂΩ¢Ôºâ
        showCenterFeedback(icon, color, text) {
            // ÁßªÈô§ËàäÁöÑÂõûÈ•ãÂÖÉÁ¥†
            this.hideCenterFeedback();
            
            // ÂâµÂª∫Êñ∞ÁöÑÂõûÈ•ãÂÖÉÁ¥†
            const feedbackDiv = document.createElement('div');
            feedbackDiv.id = 'center-feedback';
            feedbackDiv.innerHTML = `
                <div class="center-feedback-content">
                    <div class="feedback-icon">${icon}</div>
                    <div class="feedback-text">${text}</div>
                </div>
            `;
            
            document.body.appendChild(feedbackDiv);
        },

        // Èö±ËóèË¶ñÁ™óÊ≠£‰∏≠Â§ÆÁöÑÂõûÈ•ãÂúñÁ§∫
        hideCenterFeedback() {
            const existingFeedback = document.getElementById('center-feedback');
            if (existingFeedback) {
                existingFeedback.remove();
            }
        },

        // =====================================================
        // ÈÄöÁî®Â∑•ÂÖ∑ÂáΩÂºè
        // =====================================================
        updateProgress() {
            const progressInfo = document.querySelector('.progress-info');
            const scoreInfo = document.querySelector('.score-info');
            if (progressInfo) {
                progressInfo.textContent = `Á¨¨ ${this.state.currentQuestionIndex} / ${this.state.totalQuestions} È°å`;
            }
            if (scoreInfo) {
                scoreInfo.textContent = `ÂàÜÊï∏: ${this.state.score * 10} ÂàÜ`;
            }
        },

        endGame() {
            const gameContainer = document.getElementById('app');
            const correctCount = this.state.score;
            const scoreInPoints = correctCount * 10;
            const totalQuestions = this.state.totalQuestions;
            const percentage = Math.round((correctCount / totalQuestions) * 100);
            
            let performanceMessage = '';
            let performanceIcon = '';
            if (percentage >= 90) {
                performanceMessage = 'Ë°®ÁèæÂÑ™Áï∞ÔºÅ';
                performanceIcon = 'üèÜ';
            } else if (percentage >= 70) {
                performanceMessage = 'Ë°®ÁèæËâØÂ•ΩÔºÅ';
                performanceIcon = 'üëç';
            } else if (percentage >= 50) {
                performanceMessage = 'ÈÇÑÈúÄÂä™ÂäõÔºÅ';
                performanceIcon = 'üí™';
            } else {
                performanceMessage = 'Â§öÂä†Á∑¥ÁøíÔºÅ';
                performanceIcon = 'üìö';
            }

            gameContainer.innerHTML = `
                <div class="game-complete">
                    <div class="result-card">
                        <div class="results-header">
                            <div class="trophy-icon">${performanceIcon}</div>
                            <h1>üéâ Ê∏¨È©óÁµêÊùü üéâ</h1>
                            <div class="achievement-message">
                                <p><strong>${performanceMessage}</strong></p>
                            </div>
                        </div>
                        
                        <div class="final-stats">
                            <div class="stat-item">
                                <span class="stat-label">Á≠îÂ∞çÈ°åÊï∏</span>
                                <span class="stat-value">${correctCount} / ${totalQuestions}</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Á∏ΩÂàÜ</span>
                                <span class="stat-value">${scoreInPoints} ÂàÜ</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Ê≠£Á¢∫Áéá</span>
                                <span class="stat-value">${percentage}%</span>
                            </div>
                        </div>
                        
                        <div class="action-buttons">
                            <button class="primary-btn" onclick="location.reload()">
                                üîÑ ÂÜçÁé©‰∏ÄÊ¨°
                            </button>
                            <button class="secondary-btn" onclick="window.location.href='index.html'">
                                üè† ËøîÂõû‰∏ªÈÅ∏ÂñÆ
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Êí≠ÊîæÊàêÂäüÈü≥ÊïàÂíåË™ûÈü≥
            setTimeout(() => {
                document.getElementById('success-sound')?.play();
                this.triggerConfetti();
                
                let finalText = '';
                if (percentage === 100) {
                    finalText = `Â§™Âé≤ÂÆ≥‰∫ÜÔºå‰Ω†ÂÖ®ÈÉ®Á≠îÂ∞ç‰∫ÜÔºåÊÅ≠Âñú‰Ω†ÂæóÂà∞${scoreInPoints}ÂàÜÔºÅ`;
                } else if (percentage >= 80) {
                    finalText = `ÂæàÊ£íÂñîÔºå‰Ω†Á∏ΩÂÖ±Á≠îÂ∞ç‰∫Ü${correctCount}È°åÔºåÊÅ≠Âñú‰Ω†ÂæóÂà∞‰∫Ü${scoreInPoints}ÂàÜ„ÄÇ`;
                } else if (percentage >= 60) {
                    finalText = `‰∏çÈåØÂñîÔºå‰Ω†Á∏ΩÂÖ±Á≠îÂ∞ç‰∫Ü${correctCount}È°åÔºåÊÅ≠Âñú‰Ω†ÂæóÂà∞‰∫Ü${scoreInPoints}ÂàÜ„ÄÇ`;
                } else {
                    finalText = `Ë¶ÅÂÜçÂä†Ê≤πÂñîÔºå‰Ω†Á∏ΩÂÖ±Á≠îÂ∞ç‰∫Ü${correctCount}È°åÔºå‰Ω†ÂæóÂà∞‰∫Ü${scoreInPoints}ÂàÜ„ÄÇ`;
                }
                this.speak(finalText);
            }, 100);
        },

        triggerConfetti() {
            if (typeof confetti !== 'function') return;
            
            const duration = 3 * 1000;
            const animationEnd = Date.now() + duration;
            const defaults = { 
                startVelocity: 30, 
                spread: 360, 
                ticks: 60, 
                zIndex: 1001 
            };
            const randomInRange = (min, max) => Math.random() * (max - min) + min;
            
            const interval = setInterval(() => {
                const timeLeft = animationEnd - Date.now();
                if (timeLeft <= 0) return clearInterval(interval);
                
                const particleCount = 50 * (timeLeft / duration);
                confetti({ 
                    ...defaults, 
                    particleCount, 
                    origin: { 
                        x: randomInRange(0.1, 0.3), 
                        y: Math.random() - 0.2 
                    } 
                });
                confetti({ 
                    ...defaults, 
                    particleCount, 
                    origin: { 
                        x: randomInRange(0.7, 0.9), 
                        y: Math.random() - 0.2 
                    } 
                });
            }, 250);
        },

        speak(text, callback) {
            if (!this.speech.isReady || !text) {
                if (callback) callback();
                return;
            }
            
            this.speech.synth.cancel();
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.voice = this.speech.voice;
            utterance.lang = this.speech.voice.lang;
            utterance.rate = 1.0;
            
            if (callback) {
                utterance.onend = callback;
            }
            
            this.speech.synth.speak(utterance);
        },

        getRandomImage(item) {
            if (!item.images || !item.images.front || !item.images.back) {
                return item.img || '';
            }
            return Math.random() < 0.5 ? item.images.front : item.images.back;
        },

        shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        },

        // Êï∏Â≠óÈÅ∏ÊìáÂô®Á≥ªÁµ±ÔºàÊé°Áî®unit2Ê®£ÂºèÔºâ
        showNumberInput(title, callback) {
            // Ê™¢Êü•ÊòØÂê¶Â∑≤Â≠òÂú®Êï∏Â≠óËº∏ÂÖ•Âô®
            if (document.getElementById('number-input-popup')) {
                return;
            }

            this.numberInputCallback = callback;
            
            const inputPopupHTML = `
                <div id="number-input-popup" class="number-input-popup">
                    <div class="number-input-container">
                        <div class="number-input-header">
                            <h3>${title}</h3>
                            <button class="close-btn" onclick="Game.closeNumberInput()">√ó</button>
                        </div>
                        <div class="number-input-display">
                            <input type="text" id="number-display" readonly value="">
                        </div>
                        <div class="number-input-buttons">
                            <button onclick="Game.appendNumber('1')">1</button>
                            <button onclick="Game.appendNumber('2')">2</button>
                            <button onclick="Game.appendNumber('3')">3</button>
                            <button onclick="Game.clearNumber()" class="clear-btn">Ê∏ÖÈô§</button>
                            
                            <button onclick="Game.appendNumber('4')">4</button>
                            <button onclick="Game.appendNumber('5')">5</button>
                            <button onclick="Game.appendNumber('6')">6</button>
                            <button onclick="Game.backspaceNumber()" class="backspace-btn">‚å´</button>
                            
                            <button onclick="Game.appendNumber('7')">7</button>
                            <button onclick="Game.appendNumber('8')">8</button>
                            <button onclick="Game.appendNumber('9')">9</button>
                            <button onclick="Game.confirmNumber()" class="confirm-btn">Á¢∫Ë™ç</button>
                            
                            <button onclick="Game.appendNumber('0')" class="zero-btn">0</button>
                        </div>
                    </div>
                </div>
            `;

            // Ê∑ªÂä†Êï∏Â≠óËº∏ÂÖ•Âô®Ê®£Âºè
            const inputStyles = `
                <style id="number-input-styles">
                    .number-input-popup {
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.7);
                        display: flex;
                        justify-content: center;
                        align-items: flex-start;
                        padding-top: 200px;
                        z-index: 10000;
                        animation: fadeIn 0.3s ease-out;
                    }

                    .number-input-container {
                        background: white;
                        border-radius: 15px;
                        padding: 20px;
                        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                        width: 320px;
                        max-width: 95vw;
                        animation: bounceIn 0.3s ease-out;
                    }

                    .number-input-header {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        margin-bottom: 20px;
                        border-bottom: 2px solid #f0f0f0;
                        padding-bottom: 10px;
                    }

                    .number-input-header h3 {
                        margin: 0;
                        color: #333;
                        font-size: 18px;
                    }

                    .close-btn {
                        background: none;
                        border: none;
                        font-size: 24px;
                        cursor: pointer;
                        color: #666;
                        padding: 0;
                        width: 30px;
                        height: 30px;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    }

                    .close-btn:hover {
                        background: #f0f0f0;
                    }

                    .number-input-display {
                        margin-bottom: 20px;
                    }

                    #number-display {
                        width: 100%;
                        border: 2px solid #ddd;
                        padding: 15px;
                        font-size: 24px;
                        text-align: center;
                        border-radius: 8px;
                        background: #f9f9f9;
                        font-family: 'Courier New', monospace;
                        box-sizing: border-box;
                    }

                    .number-input-buttons {
                        display: grid;
                        grid-template-columns: repeat(4, 1fr);
                        gap: 10px;
                    }

                    .number-input-buttons button {
                        padding: 15px;
                        font-size: 18px;
                        font-weight: bold;
                        border: 2px solid #ddd;
                        border-radius: 8px;
                        background: white;
                        cursor: pointer;
                        transition: all 0.2s;
                    }

                    .number-input-buttons button:hover {
                        background: #f0f0f0;
                        transform: translateY(-1px);
                    }

                    .number-input-buttons button:active {
                        transform: translateY(0);
                        background: #e0e0e0;
                    }

                    .number-input-buttons button.clear-btn {
                        background: #ff6b6b !important;
                        color: white !important;
                        border-color: #ff6b6b !important;
                        padding: 15px 8px !important;
                        font-size: 14px !important;
                        width: auto !important;
                        min-width: 60px !important;
                        max-width: 80px !important;
                    }

                    .number-input-buttons button.clear-btn:hover {
                        background: #ff5252 !important;
                    }

                    .number-input-buttons button.backspace-btn {
                        background: #ffa726 !important;
                        color: white !important;
                        border-color: #ffa726 !important;
                        padding: 15px 8px !important;
                        font-size: 16px !important;
                        width: auto !important;
                        min-width: 60px !important;
                        max-width: 80px !important;
                    }

                    .number-input-buttons button.backspace-btn:hover {
                        background: #ff9800 !important;
                    }

                    .number-input-buttons button.confirm-btn {
                        background: #4caf50 !important;
                        color: white !important;
                        border-color: #4caf50 !important;
                        grid-row: span 2;
                        padding: 15px 8px !important;
                        font-size: 14px !important;
                        width: auto !important;
                        min-width: 60px !important;
                        max-width: 80px !important;
                    }

                    .number-input-buttons button.confirm-btn:hover {
                        background: #45a049 !important;
                    }

                    .number-input-buttons button.zero-btn {
                        grid-column: span 3;
                    }

                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }

                    @keyframes bounceIn {
                        from {
                            opacity: 0;
                            transform: scale(0.3) translateY(-50px);
                        }
                        50% {
                            opacity: 1;
                            transform: scale(1.05) translateY(10px);
                        }
                        70% {
                            transform: scale(0.95) translateY(-5px);
                        }
                        to {
                            opacity: 1;
                            transform: scale(1) translateY(0);
                        }
                    }
                </style>
            `;

            // Ê∑ªÂä†Ê®£ÂºèÂíåÂΩàÁ™óÂà∞È†ÅÈù¢
            document.head.insertAdjacentHTML('beforeend', inputStyles);
            document.body.insertAdjacentHTML('beforeend', inputPopupHTML);
        },

        // Êï∏Â≠óËº∏ÂÖ•Âô®Áõ∏ÈóúÂáΩÊï∏
        appendNumber(number) {
            const display = document.getElementById('number-display');
            if (display.value.length < 6) {
                display.value += number;
            }
            
            // Êí≠ÊîæÈªûÊìäÈü≥Êïà
            const clickSound = document.getElementById('click-sound');
            if (clickSound) {
                clickSound.currentTime = 0;
                clickSound.play();
            }
        },

        clearNumber() {
            const display = document.getElementById('number-display');
            display.value = '';
            
            // Êí≠ÊîæÈªûÊìäÈü≥Êïà
            const clickSound = document.getElementById('click-sound');
            if (clickSound) {
                clickSound.currentTime = 0;
                clickSound.play();
            }
        },

        backspaceNumber() {
            const display = document.getElementById('number-display');
            display.value = display.value.slice(0, -1);
            
            // Êí≠ÊîæÈªûÊìäÈü≥Êïà
            const clickSound = document.getElementById('click-sound');
            if (clickSound) {
                clickSound.currentTime = 0;
                clickSound.play();
            }
        },

        confirmNumber() {
            const display = document.getElementById('number-display');
            const inputValue = display.value;
            
            if (this.numberInputCallback) {
                const result = this.numberInputCallback(inputValue);
                if (result !== false) {
                    this.closeNumberInput();
                }
            } else {
                this.closeNumberInput();
            }
        },

        closeNumberInput() {
            const popup = document.getElementById('number-input-popup');
            const styles = document.getElementById('number-input-styles');
            
            if (popup) popup.remove();
            if (styles) styles.remove();
            this.numberInputCallback = null;
        }
    };

    Game.init();
});
